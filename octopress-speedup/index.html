<!doctypehtml><html lang=en><meta charset=utf-8><title>Speeding up this site by 50x</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="stylesheet" href="/styles.css"></style><link rel=icon href="data:;base64,="> <header><strong>Speeding up this site by 50x</strong> | <i><b><a href=https://patreon.com/danluu>I'm trying some experimental tiers on Patreon</a></b> to see if I can get to <a href=https://twitter.com/danluu/status/1456346963691991041>substack-like levels of financial support for this blog without moving to substack</a>!</i><hr></header><main> <p>I've seen all these studies that show how a 100ms improvement in page load time has a significant effect on page views, conversion rate, etc., but I'd never actually tried to optimize my site. This blog is a static Octopress site, hosted on GitHub Pages. Static sites are supposed to be fast, and GitHub Pages uses Fastly, which is supposed to be fast, so everything should be fast, right?</p> <p>Not having done this before, I didn't know what to do. But in a great talk on how the internet works, <a href=https://twitter.com/danielespeset>Dan Espeset</a> suggested trying <a href=http://www.webpagetest.org>webpagetest</a>; let's give it a shot.</p>  <p>Here's what it shows with my nearly stock Octopress setup<sup class=footnote-ref id=fnref:S><a rel=footnote href=#fn:S>1</a></sup>. The only changes I'd made were enabling Google Analytics, the social media buttons at the bottom of posts, and adding CSS styling for tables (which are, by default, unstyled and unreadable).</p> <p><img src=/images/octopress-speedup/octo_initial.png alt="time to start rendering: 9.7s"> <img src=/images/octopress-speedup/octo_initial_detail.png alt="time to visual completion: 10.9s"></p> <p>12 seconds to the first page view! What happened? I thought static sites were supposed to be fast. The first byte gets there in less than half a second, but the page doesn't start rendering until 9 seconds later.</p> <p><img src=/images/octopress-speedup/octo_initial_waterfall.png alt="Lots of js, CSS, and fonts"></p> <p>Looks like the first thing that happens is that we load a bunch of <code>js</code> and <code>CSS</code>. Looking at the source, we have all this <code>js</code> in <code>source/_includes/head.html</code>.</p> <pre><code>&lt;script src=&quot;{{ root_url }}/javascripts/modernizr-2.0.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js&quot;&gt;&lt;/script&gt;
&lt;script&gt;!window.jQuery &amp;&amp; document.write(unescape('%3Cscript src=&quot;./javascripts/lib/jquery.min.js&quot;%3E%3C/script%3E'))&lt;/script&gt;
&lt;script src=&quot;{{ root_url }}/javascripts/octopress.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
{% include google_analytics.html %}
</code></pre> <p>I don't know anything about web page optimization, but Espeset mentioned that <code>js</code> will stall page loading and rendering. What if we move the scripts to <code>source/_includes/custom/after_footer.html</code>?</p> <p><img src=/images/octopress-speedup/octo_js_after_footer.png alt="time to start rendering: 4.9s"></p> <p>That's a lot better! We've just saved about 4 seconds on load time and on time to start rendering.</p> <p>Those script tags load modernizer, jquery, octopress.js, and some google analytics stuff. What is in this <code>octopress.js</code> anyway? It's mostly code to support stuff like embedding flash videos, delicious integration, and github repo integration. There are a few things that do get used for my site, but most of that code is dead weight.</p> <p>Also, why are there multiple <code>js</code> files? Espeset also mentioned that connections are finite resources, and that we'll run out of simultaneous open connections if we have a bunch of different files. Let's strip out all of that unused <code>js</code> and combine the remaining <code>js</code> into a single file.</p> <p><img src=/images/octopress-speedup/octo_one_js_file.png alt="time to start rendering: 1.4s"></p> <p>Much better! But wait a sec. What do I need <code>js</code> for? As far as I can tell, the only thing my site is still using octopress's <code>js</code> for is so that you can push the right sidebar back and forth by clicking on it, and jquery and modernizer are only necessary for the js used in octopress. I never use that, and according to in-page analytics no one else does either. Let's get rid of it.</p> <p><img src=/images/octopress-speedup/octo_no_js.png alt="time to start rendering: .7s"> <img src=/images/octopress-speedup/octo_no_js_detail.png alt="time to visual completion: 1.2s"></p> <p>That didn't change total load time much, but the browser started rendering sooner. We're down to having the site visually complete after 1.2s, compared to 9.6s initially -- an 8x improvement.</p> <p>What's left? There's still some js for the twitter and fb widgets at the bottom of each post, but those all get loaded after things are rendered, so they don't really affect the user's experience, even though they make the “Load Time” number look bad.</p> <p><img src=/images/octopress-speedup/octo_no_js_pie.png alt="That's a lot of fonts!"></p> <p>This is a pie chart of how many bytes of my page are devoted to each type of file. Apparently, the plurality of the payload is spent on fonts. Despite my reference post being an unusually image heavy blog post, fonts are 43.8% and images are such a small percentage that webpagetest doesn't even list the number. Doesn't my browser already have some default fonts? Can we just use those?</p> <p><img src=/images/octopress-speedup/octo_no_fonts.png alt="time to start rendering: .6s"> <img src=/images/octopress-speedup/octo_no_fonts_detail.png alt="time to visual completion: .9s"></p> <p>Turns out, we can. The webpage is now visually complete in 0.9s -- a 12x improvement. The improvement isn't quite as dramatic for “Repeat View”<sup class=footnote-ref id=fnref:R><a rel=footnote href=#fn:R>2</a></sup> -- it's only an 8.6x improvement there -- but that's still pretty good.</p> <p>The one remaining “obvious” issue is that the header loads two css files, one of which isn't minified. This uses up two connections and sends more data than necessary. Minifying the other css file and combining them speeds this up even further.</p> <p><img src=/images/octopress-speedup/octo_one_css.png alt="time to start rendering: .6s"> <img src=/images/octopress-speedup/octo_one_css_detail.png alt="time to visual completion: .7s"></p> <p>Time to visually complete is now 0.7s -- a 15.6x improvement<sup class=footnote-ref id=fnref:1><a rel=footnote href=#fn:1>3</a></sup>. And that's on a page that's unusually image heavy for my site.</p> <p><img src=/images/octopress-speedup/octo_one_css_waterfall.png alt="Mostly image load time"></p> <p>At this point the only things that happen before the page starts displaying are:, loading the HTML, loading the one <code>css</code> file, and loading the giant image (reliability.png).</p> <p>We've already minified the css, so the main thing left to do is to make giant image better. I already ran <code>optipng -o7 -zm1-9</code> on all my images, but ImageOptim was able to shave off another 4% of the image, giving a slight improvement. Across all the images in all my posts, ImageOptim was able to reduce images by an additional 20% over optipng, but it didn't help much in this case.</p> <p>I also tried specifying the size of the image to see if that would let the page render before the image was finished downloading, but it didn't result in much of a difference.</p> <p>After that, I couldn't think of anything else to try, but webpagetest had some helpful suggestions.</p> <p><img src=/images/octopress-speedup/octo_suggestions.png alt="Blargh github pages"></p> <p>Apparently, the server I'm on is slow (it gets a D in sending the first byte after the initial request). It also recommends caching static content, but when I look at the individual suggestions, they're mostly for widgets I don't host/control. I should use a CDN, but Github Pages doesn't put content on a CDN for bare domains unless you use a DNS alias record, and my DNS provider doesn't support alias records. That's two reasons to stop servering from Github Pages (or perhaps one reason to move off Github Pages and one reason to get another DNS provider), so I switched to Cloudflare, which shaved over 100ms off the time to first byte.</p> <p>Note that if you use Cloudflare for a static site, you'll want to create a &quot;Page Rule&quot; and enable &quot;Cache Everything&quot;. By default, Cloudflare doesn't cache HTML, which is sort of pointless on a static blog that's mostly HTML. If you've done the optimizations here, you'll also want to avoid their &quot;Rocket Loader&quot; thing which attempts to load js asynchronously by loading blocking javascript. &quot;Rocket Loader&quot; is like AMP, in that it can speed up large, bloated, websites, but is big enough that it slows down moderately optimized websites.</p> <p>Here's what happened after I initally enabled Cloudflare without realizing that I needed to create a &quot;Page Rule&quot;.</p> <p><img src=/images/octopress-speedup/octo_cloudflare_wat.png alt="Cloudflare saves 80MB out of 1GB"></p> <p>That's about a day's worth of traffic in 2013. Initially, Cloudflare was serving my CSS and redirecting to Github Pages for the HTML. Then I inlined my CSS and Cloudflare literally did nothing. Overall, Cloudflare served 80MB out of 1GB of traffic because it was only caching images and this blog is relatively light on images.</p> <p>I haven't talked about inlining CSS, but it's easy and gives a huge speedup on the first visit since it means only one connection is required to display the page, instead of two sequentialy connections. It's a disadvantage on future visits since it means that the CSS has to be re-downloaded for each page, but since most of my traffic is from people running across a single blog post, who don't click through to anything else, it's a net win. In <code>_includes/head.html</code></p> <pre><code>&lt;link href=&quot;{{ root_url }}/stylesheets/all.css&quot; media=&quot;screen, projection&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot;&gt;
</code></pre> <p>should change to</p> <pre><code>{\% include all.css %}
</code></pre> <p>In addition, there's a lot of pointless cruft in the css. Removing the stuff that, as someone who doesn't know CSS can spot as pointless (like support for delicious, support for Firefox 3.5 and below, lines that firefox flags as having syntax errors such as <code>no-wrap</code> instead of <code>nowrap</code>) cuts down the remaining CSS by about half. There's a lot of duplication remaining and I expect that the CSS could be reduced by another factor of 4, but that would require actually knowing CSS. Just doing those things, we get down to .4s before the webpage is visually complete.</p> <p><img src=/images/octopress-speedup/octo_inline_css.png alt="Inlining css"></p> <p>That's a <code>10.9/.4 = 27.5</code> fold speedup. The effect on mobile is a lot more dramatic; there, it's closer to 50x.</p> <p>I'm not sure what to think about all this. On the one hand, I'm happy that I was able to get a 25x-50x speedup on my site. On the other hand, I associate speedups of that magnitude with porting plain Ruby code to optimized C++, optimized C++ to a GPU, or GPU to quick-and-dirty exploratory ASIC. How is it possible that someone with zero knowledge of web development can get that kind of speedup by watching one presentation and then futzing around for 25 minutes? I was hoping to maybe find 100ms of slack, but it turns out there's not just 100ms, or even 1000ms, but 10000ms of slack in a Octopress setup. According to a study I've seen, going from 1000ms to 3000ms costs you 20% of your readers and 50% of your click-throughs. I haven't seen a study that looks at going from 400ms to 10900ms because the idea that a website would be that slow is so absurd that people don't even look into the possibility. But many websites are that slow!<sup class=footnote-ref id=fnref:D><a rel=footnote href=#fn:D>4</a></sup></p> <h3 id=update>Update</h3> <p>I found it too hard to futz around with trimming down the massive CSS file that comes with Octopress, so I removed all of the CSS and then added a few lines to allow for a nav bar. This makes almost no difference on the desktop benchmark above, but it's a noticable improvement for slow connections. <a href=//danluu.com/web-bloat/ >The difference is quite dramatic for 56k connections as well as connections with high packetloss</a>.</p> <p>Starting the day I made this change, my analytics data shows a noticeable improvement in engagement and traffic. There are too many things confounded here to say what caused this change (performance increase, total lack of styling, etc.), but there are a couple of things find interesting about this. First, it seems to likely show that the advice that it's very important to keep line lengths short is incorrect since, if that had a very large impact, it would've overwhelmed the other changes and resulted in reduced engagement and not increased engagement. Second, despite the Octopress design being widely used and lauded (it appears to have been the most widely used blog theme for programmers when I started my blog), it appears to cause a blog (or at least this blog) to get less readership than literally having no styling at all. Having no styling is surely not optimal, but there's something a bit funny about no styling beating the at-the-time most widely used programmer blog styling, which means it likely also beat wordpress, <a href=/writing-non-advice/#svbtle>svtble</a>, blogspot, medium, etc., since those have most oof the same ingredients as Octopress.</p> <p></p> <h4 id=resources>Resources</h4> <p>Unfortunately, the video of the presentation I'm referring to is restricted <a href="https://www.recurse.com/scout/click?t=b504af89e87b77920c9b60b2a1f6d5e8">RC</a> alums. If you're an RC alum, <a href=https://community.hackerschool.com/t/monday-night-talks-84-daniel-espeset-on-the-anatomy-of-a-web-request/25>check this out</a>. Otherwise <a href=https://hpbn.co/ >high-performance browser networking</a> is great, but much longer.</p> <h4 id=acknowledgements>Acknowledgements</h4> <p>Thanks to Leah Hanson, Daniel Espeset, and Hugo Jobling for comments/corrections/discussion.</p> <p>I'm not a front-end person, so I might be totally off in how I'm looking at these benchmarks. If so, please <a href=https://twitter.com/danluu>let me know</a>.</p>  <div class=footnotes> <hr> <ol> <li id=fn:S>From whatever version was current in September 2013. It's possible some of these issues have been fixed, but based on the extremely painful experience of other people who've tried to update their Octopress installs, it didn't seem worth making the attempt to get a newer version of Octopress. <a class=footnote-return href=#fnref:S><sup>[return]</sup></a></li> <li id=fn:R>Why is “Repeat View” slower than “First View”? <a class=footnote-return href=#fnref:R><sup>[return]</sup></a></li> <li id=fn:1>If you look at a video of loading <a href="http://www.webpagetest.org/video/view.php?id=141115_AP_12A9.1.0">the original</a> vs. <a href="http://www.webpagetest.org/video/view.php?id=141116_RH_7WC.1.0">this version</a>, the difference is pretty dramatic. <a class=footnote-return href=#fnref:1><sup>[return]</sup></a></li> <li id=fn:D>For example, <a href=//danluu.com/web-bloat/#appendix-experimental-caveats>slashdot</a> takes 15s to load over FIOS. The tests shown above were done on Cable, which is <a href=//danluu.com/web-bloat/ >substantially slower</a>. <a class=footnote-return href=#fnref:D><sup>[return]</sup></a></li> </ol> </div> </main><nav><div class=np> <a href=everything-is-broken/ >← One week of bugs</a> <a href=broken-builds/ >Build uptime →</a> </div> <div class=np> <a href= >Archive</a> <a href=https://mastodon.social/@danluu>Mastodon</a> <a href=https://threads.net/@danluu.danluu>Threads</a> </div> <div class=np> <a href=https://www.patreon.com/danluu>Patreon</a> <a href=https://www.linkedin.com/in/danluu/ >LinkedIn</a> <a href=https://twitter.com/danluu/ >Twitter</a> <a href=atom.xml>RSS</a> </div></nav>